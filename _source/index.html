---
---
<!DOCTYPE html>
<html lang="en">
<head>
    <title>A &ldquo;Frightful Number&rdquo; &ndash; Mapping Daniel Defoe&rsquo;s A Journal of the Plague Year</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <link type="text/css" media="screen" rel="stylesheet" href="ui/css/styles.css" />
    <script type="text/javascript" src="https://api.tiles.mapbox.com/mapbox.js/v2.1.5/mapbox.js"></script>
    <link type="text/css" rel="stylesheet" href="https://api.tiles.mapbox.com/mapbox.js/v2.1.5/mapbox.css" media="all" />

    <link type="text/css" media="screen" rel="stylesheet" href="ui/css/responsive-tables.css" />
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
    <script type="text/javascript" src="ui/js/responsive-tables.js"></script>

    <style type="text/css">
        /* Dynamically set up CSS styles for event data in the timeline based on corresponding parishes */
    {% for parish in site.data.parishes %}
        tr.parish-{{ parish.id }} td { background: {{ parish.background-color }}; }
    {% endfor %}
    </style>
</head>

<body>
    <h1>A &ldquo;Frightful Number&rdquo; &ndash; Mapping Daniel Defoe&rsquo;s A Journal of the Plague Year</h1>

    <div id="map"></div>
    <script type="text/javascript" src="ui/js/script.js"></script>

    <div id="stepper">
        <a href="#" id="step-prev">&laquo;</a>
        <h2></h2>
        <p></p>
        <a href="#" id="step-next">&raquo;</a>
    </div>
    <style type="text/css">
        #stepper {
            position: relative;
        }
        #stepper h2,
        #stepper p {
            line-height: 1em;
            margin-bottom: 0;
            text-align: center;
        }
        #stepper a {
            position: absolute;
            top: 10px;
            right: 0px;
        }
        #stepper a:first-child {
            position: absolute;
            top: 10px;
            left: 0px;
        }
    </style>



    <div class="itinerary">
        {% assign events = site.data.a-frightful-number-plague | group_by:"date_year" %}
        {% for year in events %}
        <table border="0" cellpadding="0" cellspacing="0">
            <tr>
                <th><h3>{{ year.name }}</h3></th>
            </tr>
        </table>
        <table border="0" cellpadding="0" cellspacing="0" width="100%" class="responsive">
            <tr>
                <th width="8%">Date</th>
                <th width="12%">Parish</th>
                <th width="8%">Buried Plague</th>
                <th width="6%">Buried Parish</th>
                <th width="8%">Buried Plague Total</th>
                <th width="6%">Buried Total</th>
                <th width="12%">Location</th>
                <th width="40%">Notes</th>
            </tr>

            {% for event in year.items %}
            <tr class="{% cycle 'odd', 'even' %} parish-{{ event.parish_id }}">
                <td id="event-{{ event.sequence }}">{{ event.date_descriptive }}</td>
                <td>{% if event.parish_id != null %}<a href="#" onclick="javascript:parishPolygon{{ event.parish_id }}.openPopup();">{% endif %}{{ event.parish }}{% if event.parish_id != null %}</a>{% endif %}</td>
                <td>{{ event.buried_plague }}</td>
                <td>{{ event.buried_parish_total }}</td>
                <td>{{ event.buried_plague_total }}</td>
                <td>{{ event.buried_total }}</td>
                <td>{{ event.location_descriptive }}</td>
                <td>{{ event.notes }}</td>
            </tr>
            {% endfor %}
        </table>
        {% endfor %}
    </div>
    <script type="text/javascript">
    // Dynamically add parishes to the map and load in their data/content based on Jekyll data files.
    var $parishPolygons = [];
    {% for parish in site.data.parishes %}
        // Fetch GeoJSON markers for parish polygon vertices
        var parishPolygon{{ parish.id }};
        $.getJSON( "geojson/parish-{{ parish.id }}.geojson", function (data) {
            var popupContents;
            var vertices = [];
            $.each( data.features, function(i, feature) {
                vertices.push([ feature.geometry.coordinates[1], feature.geometry.coordinates[0] ])
            })
            parishPolygon{{ parish.id }} = L.polygon([ vertices ], { color: "{{ parish.color }}" }).addTo(map);

            $parishPolygons.push( [
                parishPolygon{{ parish.id }},
                '{{ parish.color }}'
            ] );
            //console.log($parishPolygons);

            popupContents =  '<div style="max-height: 175px; overflow-y: scroll;">';
            popupContents += "<h3>{{ parish.parish-name }}</h3>";
            popupContents += "<dl>";
            {% assign events = site.data.a-frightful-number-plague | where:"parish_id",{{parish.id}} %}
            {% for event in events %}
            popupContents += '<dt><a href="#event-{{ event.sequence }}">{{ event.date_descriptive }}</a></dt>'
            popupContents += "<dd><b>Buried Plague: {% if event.buried_plague != null %}{{ event.buried_plague }}{% else %}0{% endif %}.</b> {{ event.notes }}</dd>";
            {% endfor %}
            popupContents += '</dl></div>';
            //console.log('{{ parish.id }} ' + popupContents);
            parishPolygon{{ parish.id }}.bindPopup( popupContents );
            //console.log('parishPolygon{{ parish.id }}');
        } )
    {% endfor %}
    </script>

    <script type="text/javascript">
        var $itineraryData;
        var $stepperEnabled = false;
        $.getJSON( "datajson/a-frightful-number-plague.json", function (data) {
            console.log('json fetched');
            $itineraryData = data.events;
            $stepperEnabled = true;
            currentEvent(0);
        })
        .fail(function( jqxhr, textStatus, error ) {
            var err = textStatus + ", " + error;
            console.log( "Request Failed: " + err );
        });
        $itineraryIndex = 0;
        $('#stepper a:first-child').on('click', function(e) {
            e.preventDefault();
            console.log('prev clicked');
            if ( $itineraryIndex > 0 && $stepperEnabled) {
                $itineraryIndex--;
                currentEvent($itineraryIndex);
            }
            //console.log($itineraryIndex);
        });
        $('#stepper a:last-child').on('click', function(e) {
            e.preventDefault();
            console.log('next clicked');
            if ( $itineraryIndex < $itineraryData.length && $stepperEnabled) {
                $itineraryIndex++;
                currentEvent($itineraryIndex);
            }
            //console.log($itineraryIndex);
        });
        function currentEvent($itineraryIndex) {
            // reset all polygons
            console.log('currentEvent');
            //console.log($parishPolygons);
            $.each( $parishPolygons, function( $i, polygon) {
                polygon[0].setStyle({'color': polygon[1]});
                console.log(polygon[0]);
                console.log(polygon[1]);
            });

            // Use fadeOut / fadeIn so it's clear we're stepping when the date and parish name might be the same as previous
            $('#stepper h2').fadeOut(function(){ $(this).text($itineraryData[$itineraryIndex].year).fadeIn() });
            $('#stepper p').fadeOut(function() { $(this).html($itineraryData[$itineraryIndex].date_descriptive + '<br />' + $itineraryData[$itineraryIndex].location_descriptive + $itineraryData[$itineraryIndex].parish).fadeIn() });

            //console.log('parishPolygon' + $itineraryData[$itineraryIndex].parish_id);

            //console.log(eval('parishPolygon' + $itineraryData[$itineraryIndex].parish_id));
            //console.log(eval('parishPolygon' + $itineraryData[$itineraryIndex].parish_id).options['color']);
            eval('parishPolygon' + $itineraryData[$itineraryIndex].parish_id).setStyle({'color': '#d31603'});
            //console.log(eval('parishPolygon' + $itineraryData[$itineraryIndex].parish_id).options['color']);


        }
    </script>
</body>
</html>
